{"version":3,"sources":["useToaster.ts"],"sourcesContent":["import * as React from 'react';\nimport { isHTMLElement, useEventCallback, useForceUpdate } from '@fluentui/react-utilities';\nimport { useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\nimport { createToaster } from './vanilla';\nimport type {\n  CommonToastDetail,\n  ShowToastEventDetail,\n  Toast,\n  ToastListenerMap,\n  ToastPosition,\n  ToasterId,\n  ToasterOptions,\n} from './types';\nimport { EVENTS } from './constants';\n\nexport function useToaster<TElement extends HTMLElement = HTMLDivElement>(options: Partial<ToasterOptions> = {}) {\n  const forceUpdate = useForceUpdate();\n  const { toasterId: userToasterId, shortcuts } = options;\n  // Currently the toaster options can never be changed at runtime\n  const [toaster] = React.useState(() => createToaster(options));\n  const { targetDocument } = useFluent();\n\n  const lastActiveElementRef = React.useRef<HTMLElement | null>(null);\n\n  const isCorrectToaster = useEventCallback((toasterId: ToasterId | undefined) => {\n    return toasterId === userToasterId;\n  });\n\n  const isFocusShortcut = useEventCallback((e: KeyboardEvent) => {\n    if (shortcuts?.focus) {\n      return shortcuts.focus(e);\n    }\n  });\n\n  const pauseAllToasts = React.useCallback(() => {\n    toaster.visibleToasts.forEach(toastId => {\n      const toast = toaster.toasts.get(toastId);\n      toast?.imperativeRef.current?.pause();\n    });\n  }, [toaster]);\n\n  const playAllToasts = React.useCallback(() => {\n    toaster.visibleToasts.forEach(toastId => {\n      const toast = toaster.toasts.get(toastId);\n      toast?.imperativeRef.current?.play();\n    });\n  }, [toaster]);\n\n  const getMostRecentVisibleToast = React.useCallback(() => {\n    return Array.from(toaster.visibleToasts).reduce((cur, next) => {\n      const toast = toaster.toasts.get(next);\n      if (!toast) {\n        return cur;\n      }\n\n      if (!cur) {\n        return toast;\n      }\n\n      if (cur.order < toast?.order) {\n        return toast;\n      }\n\n      return cur;\n    }, undefined as Toast | undefined);\n  }, [toaster]);\n\n  const tryRestoreFocus = React.useCallback(() => {\n    const mostRecentToast = getMostRecentVisibleToast();\n    if (mostRecentToast?.imperativeRef.current) {\n      mostRecentToast.imperativeRef.current.focus();\n    } else {\n      lastActiveElementRef.current?.focus();\n      lastActiveElementRef.current = null;\n    }\n  }, [getMostRecentVisibleToast]);\n\n  const closeAllToasts = React.useCallback(() => {\n    toaster.visibleToasts.forEach(toastId => {\n      const toast = toaster.toasts.get(toastId);\n      toast?.close();\n    });\n\n    tryRestoreFocus();\n  }, [toaster, tryRestoreFocus]);\n\n  React.useEffect(() => {\n    if (!targetDocument) {\n      return;\n    }\n\n    const addToastListener = <TType extends keyof ToastListenerMap>(\n      eventType: TType,\n      callback: ToastListenerMap[TType],\n    ) => {\n      const listener: ToastListenerMap[TType] = (e: CustomEvent<CommonToastDetail>) => {\n        if (!isCorrectToaster(e.detail.toasterId)) {\n          return;\n        }\n\n        callback(e as CustomEvent<ShowToastEventDetail>);\n        forceUpdate();\n      };\n\n      targetDocument.addEventListener(eventType, listener as () => void);\n      return () => targetDocument.removeEventListener(eventType, listener as () => void);\n    };\n\n    const buildToast: ToastListenerMap[typeof EVENTS.show] = e => {\n      toaster.buildToast(e.detail, forceUpdate);\n    };\n\n    const dismissToast: ToastListenerMap[typeof EVENTS.dismiss] = e => {\n      toaster.dismissToast(e.detail.toastId);\n    };\n\n    const updateToast: ToastListenerMap[typeof EVENTS.update] = e => {\n      toaster.updateToast(e.detail);\n    };\n\n    const dismissAllToasts: ToastListenerMap[typeof EVENTS.dismissAll] = e => {\n      toaster.dismissAllToasts();\n    };\n\n    const pauseToast: ToastListenerMap[typeof EVENTS.pause] = e => {\n      const toast = toaster.toasts.get(e.detail.toastId);\n      if (toast) {\n        toast.imperativeRef.current?.pause();\n      }\n    };\n\n    const playToast: ToastListenerMap[typeof EVENTS.play] = e => {\n      const toast = toaster.toasts.get(e.detail.toastId);\n      if (toast) {\n        toast.imperativeRef.current?.play();\n      }\n    };\n\n    const cleanupBuildListener = addToastListener(EVENTS.show, buildToast);\n    const cleanupUpdateListener = addToastListener(EVENTS.update, updateToast);\n    const cleanupDismissListener = addToastListener(EVENTS.dismiss, dismissToast);\n    const cleanupDismissAllListener = addToastListener(EVENTS.dismissAll, dismissAllToasts);\n    const cleanupPauseListener = addToastListener(EVENTS.pause, pauseToast);\n    const cleanupPlayListener = addToastListener(EVENTS.play, playToast);\n\n    const focusShortcutListener = (e: KeyboardEvent) => {\n      if (isFocusShortcut(e)) {\n        pauseAllToasts();\n        const mostRecentToast = getMostRecentVisibleToast();\n\n        if (mostRecentToast) {\n          lastActiveElementRef.current = isHTMLElement(targetDocument.activeElement)\n            ? targetDocument.activeElement\n            : null;\n          mostRecentToast.imperativeRef.current?.focus();\n        }\n      }\n    };\n\n    targetDocument.addEventListener('keydown', focusShortcutListener);\n\n    return () => {\n      cleanupBuildListener();\n      cleanupDismissAllListener();\n      cleanupUpdateListener();\n      cleanupDismissListener();\n      cleanupPauseListener();\n      cleanupPlayListener();\n\n      targetDocument.removeEventListener('keydown', focusShortcutListener);\n    };\n  }, [\n    toaster,\n    forceUpdate,\n    targetDocument,\n    isCorrectToaster,\n    pauseAllToasts,\n    getMostRecentVisibleToast,\n    isFocusShortcut,\n  ]);\n\n  const toastsToRender = (() => {\n    if (!toaster) {\n      return new Map<ToastPosition, Toast[]>();\n    }\n\n    const toRender = new Map<ToastPosition, Toast[]>();\n    const toasts = Array.from(toaster.toasts.values());\n\n    toasts.forEach(toast => {\n      const { position } = toast;\n      toRender.has(position) || toRender.set(position, []);\n      if (position.startsWith('bottom')) {\n        toRender.get(position)!.push(toast);\n      } else {\n        toRender.get(position)!.unshift(toast);\n      }\n    });\n\n    return toRender;\n  })();\n\n  return {\n    isToastVisible: toaster.isToastVisible,\n    toastsToRender,\n    pauseAllToasts,\n    playAllToasts,\n    tryRestoreFocus,\n    closeAllToasts,\n  };\n}\n"],"names":["React","isHTMLElement","useEventCallback","useForceUpdate","useFluent_unstable","useFluent","createToaster","EVENTS","useToaster","options","forceUpdate","toasterId","userToasterId","shortcuts","toaster","useState","targetDocument","lastActiveElementRef","useRef","isCorrectToaster","isFocusShortcut","e","focus","pauseAllToasts","useCallback","visibleToasts","forEach","toastId","toast","toasts","get","imperativeRef","current","pause","playAllToasts","play","getMostRecentVisibleToast","Array","from","reduce","cur","next","order","undefined","tryRestoreFocus","mostRecentToast","closeAllToasts","close","useEffect","addToastListener","eventType","callback","listener","detail","addEventListener","removeEventListener","buildToast","dismissToast","updateToast","dismissAllToasts","pauseToast","playToast","cleanupBuildListener","show","cleanupUpdateListener","update","cleanupDismissListener","dismiss","cleanupDismissAllListener","dismissAll","cleanupPauseListener","cleanupPlayListener","focusShortcutListener","activeElement","toastsToRender","Map","toRender","values","position","has","set","startsWith","push","unshift","isToastVisible"],"mappings":"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"}